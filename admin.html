<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - TaxLetterHelp</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body style="background:#0f172a; color:#fff; font-family:'Inter',sans-serif; padding:20px;">
  <div style="max-width:1200px; margin:0 auto;">
    <h1>Admin Dashboard</h1>
    <p>Enter your admin key to access records and site navigation.</p>
    <input type="password" id="adminKey" placeholder="Enter admin key" style="padding:10px; width:300px; border-radius:6px;">
    <button id="accessBtn" style="margin-left:10px;">Access Dashboard</button>

    <!-- Site Navigation -->
    <div id="siteNav" style="display:none; margin-top:30px; padding:20px; background:#1e293b; border-radius:8px;">
      <h2 style="color:#22c55e; margin-bottom:20px;">Site Navigation & Testing</h2>
      
      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:20px;">
        <a href="/" style="background:#3b82f6; color:#fff; padding:12px 16px; border-radius:6px; text-decoration:none; text-align:center;">🏠 Home</a>
        <a href="/payment.html" style="background:#22c55e; color:#fff; padding:12px 16px; border-radius:6px; text-decoration:none; text-align:center;">💳 Payment</a>
        <a href="/upload.html" style="background:#f59e0b; color:#fff; padding:12px 16px; border-radius:6px; text-decoration:none; text-align:center;">📤 Upload</a>
        <a href="/resource.html" style="background:#8b5cf6; color:#fff; padding:12px 16px; border-radius:6px; text-decoration:none; text-align:center;">🤖 AI Analysis</a>
        <a href="/pricing.html" style="background:#06b6d4; color:#fff; padding:12px 16px; border-radius:6px; text-decoration:none; text-align:center;">💰 Pricing</a>
        <a href="/thank-you.html" style="background:#10b981; color:#fff; padding:12px 16px; border-radius:6px; text-decoration:none; text-align:center;">✅ Success</a>
      </div>

      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:20px;">
        <a href="/dashboard.html" style="background:#6366f1; color:#fff; padding:12px 16px; border-radius:6px; text-decoration:none; text-align:center;">📊 Dashboard</a>
        <a href="/login.html" style="background:#64748b; color:#fff; padding:12px 16px; border-radius:6px; text-decoration:none; text-align:center;">🔐 Login</a>
        <a href="/signup.html" style="background:#64748b; color:#fff; padding:12px 16px; border-radius:6px; text-decoration:none; text-align:center;">📝 Signup</a>
        <a href="/privacy.html" style="background:#6b7280; color:#fff; padding:12px 16px; border-radius:6px; text-decoration:none; text-align:center;">🔒 Privacy</a>
        <a href="/terms.html" style="background:#6b7280; color:#fff; padding:12px 16px; border-radius:6px; text-decoration:none; text-align:center;">📋 Terms</a>
        <a href="/disclaimer.html" style="background:#6b7280; color:#fff; padding:12px 16px; border-radius:6px; text-decoration:none; text-align:center;">⚠️ Disclaimer</a>
      </div>

      <!-- Testing Tools -->
      <div style="background:#0f172a; padding:20px; border-radius:8px; margin-top:20px;">
        <h3 style="color:#22c55e; margin-bottom:15px;">🧪 Testing Tools</h3>
        
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:15px;">
          <button id="testAnalysis" style="background:#dc2626; color:#fff; padding:10px 16px; border-radius:6px; border:none; cursor:pointer;">Test AI Analysis</button>
          <button id="testPayment" style="background:#dc2626; color:#fff; padding:10px 16px; border-radius:6px; border:none; cursor:pointer;">Test Payment Flow</button>
          <button id="testEmail" style="background:#dc2626; color:#fff; padding:10px 16px; border-radius:6px; border:none; cursor:pointer;">Test Email Function</button>
          <button id="testPDF" style="background:#dc2626; color:#fff; padding:10px 16px; border-radius:6px; border:none; cursor:pointer;">Test PDF Export</button>
        </div>
        
        <div id="testResults" style="margin-top:15px; padding:10px; background:#1e293b; border-radius:6px; min-height:50px; display:none;">
          <h4 style="color:#22c55e; margin-bottom:10px;">Test Results:</h4>
          <pre id="testOutput" style="color:#fff; white-space:pre-wrap; font-size:12px;"></pre>
        </div>
      </div>
    </div>

    <div id="results" style="margin-top:30px;"></div>
  </div>

  <script>
    const btn = document.getElementById('accessBtn');
    const results = document.getElementById('results');
    const siteNav = document.getElementById('siteNav');
    const testResults = document.getElementById('testResults');
    const testOutput = document.getElementById('testOutput');

    btn.onclick = async () => {
      const key = document.getElementById('adminKey').value.trim();
      if (!key) return alert('Enter your admin key.');
      
      // Show navigation immediately
      siteNav.style.display = 'block';
      
      results.innerHTML = '<p>Loading records...</p>';
      const res = await fetch('/.netlify/functions/admin', {
        headers: { Authorization: `Bearer ${key}` }
      });
      const data = await res.json();
      if (data.error) {
        results.innerHTML = `<p style="color:red;">${data.error}</p>`;
        return;
      }
      const rows = (data.records || []).map(r => `
        <tr>
          <td>${r.id}</td>
          <td>${r.user_email || ''}</td>
          <td>${r.price_id || ''}</td>
          <td>${r.stripe_payment_status || ''}</td>
          <td>${r.status}</td>
          <td>${(r.summary || '').slice(0,120).replace(/</g,'&lt;')}...</td>
          <td>${new Date(r.created_at).toLocaleString()}</td>
        </tr>
      `).join('');

      results.innerHTML = `
        <h2>AI Records (latest)</h2>
        <table border="1" cellpadding="8" style="border-collapse:collapse; width:100%; color:#fff;">
          <thead>
            <tr style="background:#1e293b;">
              <th>ID</th><th>Email</th><th>Price</th><th>Pay</th><th>Status</th><th>Summary</th><th>Date</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    };

    // Testing Functions
    document.getElementById('testAnalysis').onclick = async () => {
      testResults.style.display = 'block';
      testOutput.textContent = 'Testing AI Analysis...';
      
      try {
        const res = await fetch('/.netlify/functions/analyze-letter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            text: 'This is a test CP2000 notice for income discrepancy. Please analyze this letter.' 
          })
        });
        const data = await res.json();
        testOutput.textContent = `AI Analysis Test Result:\n${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        testOutput.textContent = `AI Analysis Test Error: ${error.message}`;
      }
    };

    document.getElementById('testPayment').onclick = async () => {
      testResults.style.display = 'block';
      testOutput.textContent = 'Testing Payment Flow...';
      
      try {
        const res = await fetch('/.netlify/functions/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const data = await res.json();
        testOutput.textContent = `Payment Test Result:\n${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        testOutput.textContent = `Payment Test Error: ${error.message}`;
      }
    };

    document.getElementById('testEmail').onclick = async () => {
      testResults.style.display = 'block';
      testOutput.textContent = 'Testing Email Function...';
      
      try {
        const res = await fetch('/.netlify/functions/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            recordId: 'test-record-id',
            to: 'test@example.com'
          })
        });
        const data = await res.json();
        testOutput.textContent = `Email Test Result:\n${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        testOutput.textContent = `Email Test Error: ${error.message}`;
      }
    };

    document.getElementById('testPDF').onclick = async () => {
      testResults.style.display = 'block';
      testOutput.textContent = 'Testing PDF Export...';
      
      try {
        const res = await fetch('/.netlify/functions/export-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            recordId: 'test-record-id'
          })
        });
        const data = await res;
        testOutput.textContent = `PDF Test Result: Status ${data.status} - ${data.ok ? 'Success' : 'Failed'}`;
      } catch (error) {
        testOutput.textContent = `PDF Test Error: ${error.message}`;
      }
    };
  </script>
</body>
</html>
